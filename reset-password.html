<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - MandaAct</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9fafb;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }
        .logo {
            text-align: center;
            margin-bottom: 8px;
        }
        .logo-text {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .logo-text .manda {
            color: #111;
        }
        .logo-text .act {
            background: linear-gradient(135deg, #2563eb 0%, #9333ea 50%, #db2777 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 24px;
        }
        h1 {
            font-size: 1.25rem;
            color: #111;
            margin-bottom: 24px;
            text-align: center;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 16px;
        }
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Pretendard', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #9333ea;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }
        /* Gradient border button */
        .btn-wrapper {
            padding: 2px;
            background: linear-gradient(135deg, #2563eb 0%, #9333ea 50%, #db2777 100%);
            border-radius: 10px;
            margin-top: 8px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Pretendard', sans-serif;
            background: white;
            color: transparent;
            background-image: linear-gradient(135deg, #2563eb 0%, #9333ea 50%, #db2777 100%);
            -webkit-background-clip: text;
            background-clip: text;
            transition: opacity 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.875rem;
            display: none;
        }
        .message.error {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .message.success {
            background-color: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        .message.show {
            display: block;
        }
        .password-hint {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 4px;
        }
        .success-view {
            text-align: center;
            display: none;
        }
        .success-view.show {
            display: block;
        }
        .success-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }
        .success-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }
        .success-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111;
            margin-bottom: 8px;
        }
        .success-desc {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 24px;
        }
        .form-view {
            display: block;
        }
        .form-view.hide {
            display: none;
        }
        .error-view {
            text-align: center;
            display: none;
        }
        .error-view.show {
            display: block;
        }
        .error-icon {
            width: 64px;
            height: 64px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }
        .error-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111;
            margin-bottom: 8px;
        }
        .error-desc {
            color: #6b7280;
            font-size: 0.875rem;
        }
        .footer {
            text-align: center;
            margin-top: 24px;
            color: #9ca3af;
            font-size: 0.75rem;
        }
        .lang-switch {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        .lang-btn {
            padding: 6px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-family: 'Pretendard', sans-serif;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: #f3f4f6;
            border-color: #d1d5db;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <span class="logo-text"><span class="manda">Manda</span><span class="act">Act</span></span>
        </div>
        <p class="subtitle" id="tagline">목표를 실천으로</p>

        <div class="lang-switch">
            <button class="lang-btn" onclick="setLang('en')">EN</button>
            <button class="lang-btn active" onclick="setLang('ko')">KO</button>
        </div>

        <!-- Form View -->
        <div class="form-view" id="formView">
            <h1 id="title">비밀번호 재설정</h1>

            <div class="message error" id="errorMsg"></div>

            <form id="resetForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label for="password" id="passwordLabel">새 비밀번호</label>
                    <input type="password" id="password" required minlength="6" autocomplete="new-password">
                    <p class="password-hint" id="passwordHint">6자 이상 입력해주세요</p>
                </div>

                <div class="form-group">
                    <label for="confirmPassword" id="confirmLabel">비밀번호 확인</label>
                    <input type="password" id="confirmPassword" required minlength="6" autocomplete="new-password">
                </div>

                <div class="btn-wrapper">
                    <button type="submit" class="btn" id="submitBtn">
                        <span id="submitText">비밀번호 변경</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Success View -->
        <div class="success-view" id="successView">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="success-title" id="successTitle">비밀번호 변경 완료!</h2>
            <p class="success-desc" id="successDesc">비밀번호가 성공적으로 변경되었습니다.<br>앱에서 새 비밀번호로 로그인해주세요.</p>
        </div>

        <!-- Error View (Invalid/Expired Token) -->
        <div class="error-view" id="errorView">
            <div class="error-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#dc2626" width="32" height="32">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="error-title" id="errorTitle">유효하지 않은 링크</h2>
            <p class="error-desc" id="errorDesc">이 비밀번호 재설정 링크는 유효하지 않거나 만료되었습니다.<br>앱에서 비밀번호 재설정을 다시 요청해주세요.</p>
        </div>

        <div class="footer">
            &copy; 2025 MandaAct by UnwrittenBD
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://gxnvovnwlqjstpcsprqr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4bnZvdm53bHFqc3RwY3NwcnFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA0MjY2MDAsImV4cCI6MjA0NjAwMjYwMH0.2_lEZIyVU1LXeyJh9FWzMO_pF-abSykSLuqUwc1GwRM';

        // i18n
        const translations = {
            en: {
                tagline: 'Turn goals into action',
                title: 'Reset Password',
                passwordLabel: 'New Password',
                passwordHint: 'At least 6 characters',
                confirmLabel: 'Confirm Password',
                submitText: 'Reset Password',
                submitting: 'Resetting...',
                successTitle: 'Password Changed!',
                successDesc: 'Your password has been successfully changed.<br>Please log in with your new password in the app.',
                errorTitle: 'Invalid Link',
                errorDesc: 'This password reset link is invalid or has expired.<br>Please request a new password reset in the app.',
                mismatch: 'Passwords do not match.',
                tooShort: 'Password must be at least 6 characters.',
                genericError: 'An error occurred. Please try again.'
            },
            ko: {
                tagline: '목표를 실천으로',
                title: '비밀번호 재설정',
                passwordLabel: '새 비밀번호',
                passwordHint: '6자 이상 입력해주세요',
                confirmLabel: '비밀번호 확인',
                submitText: '비밀번호 변경',
                submitting: '변경 중...',
                successTitle: '비밀번호 변경 완료!',
                successDesc: '비밀번호가 성공적으로 변경되었습니다.<br>앱에서 새 비밀번호로 로그인해주세요.',
                errorTitle: '유효하지 않은 링크',
                errorDesc: '이 비밀번호 재설정 링크는 유효하지 않거나 만료되었습니다.<br>앱에서 비밀번호 재설정을 다시 요청해주세요.',
                mismatch: '비밀번호가 일치하지 않습니다.',
                tooShort: '비밀번호는 6자 이상이어야 합니다.',
                genericError: '오류가 발생했습니다. 다시 시도해주세요.'
            }
        };

        let currentLang = 'ko';
        let accessToken = null;

        function setLang(lang) {
            currentLang = lang;
            const t = translations[lang];

            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');

            document.getElementById('tagline').textContent = t.tagline;
            document.getElementById('title').textContent = t.title;
            document.getElementById('passwordLabel').textContent = t.passwordLabel;
            document.getElementById('passwordHint').textContent = t.passwordHint;
            document.getElementById('confirmLabel').textContent = t.confirmLabel;
            document.getElementById('submitText').textContent = t.submitText;
            document.getElementById('successTitle').textContent = t.successTitle;
            document.getElementById('successDesc').innerHTML = t.successDesc;
            document.getElementById('errorTitle').textContent = t.errorTitle;
            document.getElementById('errorDesc').innerHTML = t.errorDesc;
        }

        function parseHashParams() {
            const hash = window.location.hash.substring(1);
            const params = {};
            hash.split('&').forEach(part => {
                const [key, value] = part.split('=');
                if (key && value) {
                    params[key] = decodeURIComponent(value);
                }
            });
            return params;
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }

        async function handleSubmit(e) {
            e.preventDefault();
            hideError();

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const t = translations[currentLang];

            if (password.length < 6) {
                showError(t.tooShort);
                return;
            }

            if (password !== confirmPassword) {
                showError(t.mismatch);
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            submitBtn.disabled = true;
            submitText.textContent = t.submitting;

            try {
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (!response.ok) {
                    console.error('Error response:', data);
                    throw new Error(data.error_description || data.msg || 'Failed to update password');
                }

                // Show success view
                document.getElementById('formView').classList.add('hide');
                document.getElementById('successView').classList.add('show');
            } catch (error) {
                console.error('Error:', error);
                showError(t.genericError);
                submitBtn.disabled = false;
                submitText.textContent = t.submitText;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const params = parseHashParams();

            // Check for valid recovery token
            if (params.type === 'recovery' && params.access_token) {
                accessToken = params.access_token;
                // Form view is already visible
            } else {
                // Show error view for invalid/missing token
                document.getElementById('formView').classList.add('hide');
                document.getElementById('errorView').classList.add('show');
            }

            // Auto-detect language from browser
            const browserLang = navigator.language.startsWith('ko') ? 'ko' : 'en';
            setLang(browserLang);
        });
    </script>
</body>
</html>
